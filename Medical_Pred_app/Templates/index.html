<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medical Cost Prediction</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Popup bar (toast) */
    #popupBar {
      visibility: hidden;
      min-width: 420px;
      max-width: 600px;
      background-color: #eafaf1; /* light green default */
      color: #1e7e34;
      font-weight: 600;
      text-align: left;
      border-radius: 12px;
      padding: 18px 50px 18px 20px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      font-size: 1.1rem;
      box-shadow: 0px 6px 20px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }
    #popupBar.show {
      visibility: visible;
      opacity: 1;
      bottom: 60px;
    }
    /* Close button */
    #popupClose {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üíä Medical Cost Prediction</h1>
    <p>Enter patient details below and press <strong>Predict</strong> to estimate insurance charges.</p>
    <div class="card">
      <form id="predictForm" onsubmit="return false;" autocomplete="off">
        <div class="field">
          <label for="age">Age</label>
          <input id="age" name="age" type="number" min="0" max="100" required placeholder="0 - 100">
        </div>
        <div class="field">
          <label for="bmi">BMI <small>(Body Mass Index)</small></label>
          <input id="bmi" name="bmi" type="number" step="0.1" min="10" max="50" required placeholder="10 - 50">
        </div>
        <div class="field">
          <label for="children">Children</label>
          <input id="children" name="children" type="number" min="0" max="10" step="1" required placeholder="0 - 10">
        </div>
        <div class="field">
          <label for="gender">Gender</label>
          <select id="gender" name="gender" required>
            <option value="" disabled selected>Choose gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="field">
          <label for="smoker">Smoker</label>
          <select id="smoker" name="smoker" required>
            <option value="" disabled selected>Smoker?</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="field">
          <label for="region">Region</label>
          <select id="region" name="region" required>
            <option value="" disabled selected>Choose region</option>
            <option value="northeast">Northeast</option>
            <option value="northwest">Northwest</option>
            <option value="southeast">Southeast</option>
            <option value="southwest">Southwest</option>
          </select>
        </div>
        <button id="submitBtn" class="btn" type="button" onclick="sendPrediction()">Predict</button>
      </form>
    </div>
  </div>

  <!-- Popup Bar -->
  <div id="popupBar">
    <span id="popupMessage"></span>
    <button id="popupClose" onclick="closePopup()">√ó</button>
  </div>

  <script>
    function showPopup(message, isError=false) {
      const popup = document.getElementById("popupBar");
      const popupMsg = document.getElementById("popupMessage");

      popupMsg.textContent = message;
      popup.style.backgroundColor = isError ? "#fff5f5" : "#eafaf1"; 
      popup.style.color = isError ? "#b00020" : "#1e7e34";

      popup.className = "show";

      // Auto hide after 5s if user doesn‚Äôt click X
      setTimeout(() => {
        closePopup();
      }, 5000);
    }

    function closePopup() {
      const popup = document.getElementById("popupBar");
      popup.className = popup.className.replace("show", "");
    }

    async function sendPrediction() {
      const submitBtn = document.getElementById('submitBtn');

      const age = Number(document.getElementById('age').value);
      const bmi = Number(document.getElementById('bmi').value);
      const children = Number(document.getElementById('children').value);
      const gender = document.getElementById('gender').value;
      const smoker = document.getElementById('smoker').value;
      const region = document.getElementById('region').value;

      if (
        !gender || !smoker || !region ||
        isNaN(age) || isNaN(bmi) || isNaN(children) ||
        age < 0 || age > 100 ||
        bmi < 10 || bmi > 50 ||
        children < 0 || children > 10
      ) {
        showPopup("‚ö†Ô∏è Please fill all fields correctly.", true);
        return;
      }

      const payload = { age, bmi, children, gender, smoker, region };

      submitBtn.disabled = true;
      submitBtn.textContent = "Predicting...";

      try {
        const resp = await fetch("/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();

        if (resp.ok && data.prediction !== undefined) {
          const pred = Array.isArray(data.prediction) ? data.prediction[0] : data.prediction;
          showPopup(`üí∞ Estimated Charges: $${Number(pred).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`);
        } else {
          showPopup("‚ö†Ô∏è " + (data.message || "Could not get prediction."), true);
        }
      } catch (err) {
        showPopup("‚ùå Error: " + (err.message || err), true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Predict";
      }
    }
  </script>
</body>
</html>
